groups:
  - name: huly_vibe_sync_alerts
    interval: 30s
    rules:
      # Sync Failure Alerts
      - alert: HighSyncFailureRate
        expr: (rate(sync_runs_total{status="error"}[5m]) / rate(sync_runs_total[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
          component: sync
        annotations:
          summary: "High sync failure rate detected"
          description: "Sync failure rate is {{ $value | humanizePercentage }} over the last 5 minutes"

      - alert: CriticalSyncFailureRate
        expr: (rate(sync_runs_total{status="error"}[5m]) / rate(sync_runs_total[5m])) > 0.5
        for: 2m
        labels:
          severity: critical
          component: sync
        annotations:
          summary: "Critical sync failure rate"
          description: "Sync failure rate is {{ $value | humanizePercentage }} over the last 5 minutes. Immediate attention required."

      - alert: NoSuccessfulSyncsRecently
        expr: increase(sync_runs_total{status="success"}[15m]) == 0
        for: 15m
        labels:
          severity: warning
          component: sync
        annotations:
          summary: "No successful syncs in 15 minutes"
          description: "The sync service has not completed any successful syncs in the last 15 minutes"

      # Performance Alerts
      - alert: SlowSyncDuration
        expr: histogram_quantile(0.95, rate(sync_duration_seconds_bucket[5m])) > 60
        for: 10m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "Slow sync duration detected"
          description: "95th percentile sync duration is {{ $value }}s, exceeding 60s threshold"

      - alert: VerySyncDuration
        expr: histogram_quantile(0.95, rate(sync_duration_seconds_bucket[5m])) > 120
        for: 5m
        labels:
          severity: critical
          component: performance
        annotations:
          summary: "Very slow sync duration"
          description: "95th percentile sync duration is {{ $value }}s, exceeding 120s threshold. Performance degradation detected."

      # API Latency Alerts
      - alert: HighHulyAPILatency
        expr: histogram_quantile(0.95, rate(huly_api_latency_seconds_bucket[5m])) > 5
        for: 10m
        labels:
          severity: warning
          component: huly_api
        annotations:
          summary: "High Huly API latency"
          description: "95th percentile Huly API latency for {{ $labels.operation }} is {{ $value }}s"

      - alert: HighVibeAPILatency
        expr: histogram_quantile(0.95, rate(vibe_api_latency_seconds_bucket[5m])) > 5
        for: 10m
        labels:
          severity: warning
          component: vibe_api
        annotations:
          summary: "High Vibe API latency"
          description: "95th percentile Vibe API latency for {{ $labels.operation }} is {{ $value }}s"

      # Memory Alerts
      - alert: HighMemoryUsage
        expr: memory_usage_bytes{type="rss"} > 500000000
        for: 5m
        labels:
          severity: warning
          component: resources
        annotations:
          summary: "High memory usage detected"
          description: "RSS memory usage is {{ $value | humanize1024 }}, exceeding 500MB threshold"

      - alert: CriticalMemoryUsage
        expr: memory_usage_bytes{type="rss"} > 1000000000
        for: 2m
        labels:
          severity: critical
          component: resources
        annotations:
          summary: "Critical memory usage"
          description: "RSS memory usage is {{ $value | humanize1024 }}, exceeding 1GB threshold. Potential memory leak."

      # Connection Pool Alerts
      - alert: HighConnectionPoolUtilization
        expr: (connection_pool_active / (connection_pool_active + connection_pool_free)) > 0.8
        for: 10m
        labels:
          severity: warning
          component: resources
        annotations:
          summary: "High connection pool utilization"
          description: "Connection pool for {{ $labels.protocol }} is {{ $value | humanizePercentage }} utilized"

      # Health Check Alerts
      - alert: ServiceDown
        expr: up{job="huly-vibe-sync"} == 0
        for: 1m
        labels:
          severity: critical
          component: health
        annotations:
          summary: "Huly-Vibe-Sync service is down"
          description: "The sync service has been down for more than 1 minute"

      # Data Volume Alerts
      - alert: UnusuallyHighProjectCount
        expr: projects_processed > 100
        for: 5m
        labels:
          severity: info
          component: data
        annotations:
          summary: "Unusually high project count"
          description: "Processing {{ $value }} projects, which is higher than normal"

      - alert: UnusuallyHighIssueCount
        expr: issues_synced > 1000
        for: 5m
        labels:
          severity: info
          component: data
        annotations:
          summary: "Unusually high issue count"
          description: "Syncing {{ $value }} issues, which is higher than normal"
