version: '3.8'

services:
  huly-vibe-sync:
    image: ghcr.io/oculairmedia/huly-vibe-sync:latest
    container_name: huly-vibe-sync
    restart: unless-stopped
    environment:
      # Huly API Configuration
      - HULY_API_URL=${HULY_API_URL:-http://192.168.50.90:3457/api}
      - HULY_USE_REST=${HULY_USE_REST:-true}

      # Vibe Kanban Configuration
      - VIBE_MCP_URL=${VIBE_MCP_URL:-http://192.168.50.90:9717/mcp}
      - VIBE_API_URL=${VIBE_API_URL:-http://192.168.50.90:3105/api}

      # Sync Configuration
      - SYNC_INTERVAL=${SYNC_INTERVAL:-10000}  # 10 seconds default
      - INCREMENTAL_SYNC=${INCREMENTAL_SYNC:-true}
      - PARALLEL_SYNC=${PARALLEL_SYNC:-true}
      - MAX_WORKERS=${MAX_WORKERS:-5}
      - SKIP_EMPTY_PROJECTS=${SKIP_EMPTY_PROJECTS:-true}
      - DRY_RUN=${DRY_RUN:-false}

      # Stacks Directory
      - STACKS_DIR=${STACKS_DIR:-/opt/stacks}

      # Node Environment
      - NODE_ENV=production

    volumes:
      # Logs directory
      - ./logs:/app/logs

      # Access to stacks directory (read-write for state persistence)
      - /opt/stacks:/opt/stacks:rw

    network_mode: host

    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
