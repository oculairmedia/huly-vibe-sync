version: '3.8'

services:
  huly-vibe-sync:
    image: ghcr.io/oculairmedia/huly-vibe-sync:latest
    container_name: huly-vibe-sync
    restart: unless-stopped
    environment:
      # Huly API Configuration
      - HULY_API_URL=${HULY_API_URL:-http://192.168.50.90:3458}
      - HULY_USE_REST=${HULY_USE_REST:-true}

      # Vibe Kanban Configuration
      - VIBE_MCP_URL=${VIBE_MCP_URL:-http://192.168.50.90:9717/mcp}
      - VIBE_API_URL=${VIBE_API_URL:-http://192.168.50.90:3105/api}

      # Change Watcher (webhook-driven sync)
      # Uses host LAN IP (not Docker bridge) â€” vibesync runs in host network mode
      - HULY_CHANGE_WATCHER_URL=http://localhost:3459
      - WEBHOOK_CALLBACK_URL=${WEBHOOK_CALLBACK_URL:-http://192.168.50.90:3099/webhook}

      # Sync Configuration
      - SYNC_INTERVAL=${SYNC_INTERVAL:-60000} # 60 seconds fallback (webhook is primary)
      - INCREMENTAL_SYNC=${INCREMENTAL_SYNC:-true}
      - PARALLEL_SYNC=${PARALLEL_SYNC:-true}
      - MAX_WORKERS=${MAX_WORKERS:-5}
      - SKIP_EMPTY_PROJECTS=${SKIP_EMPTY_PROJECTS:-true}
      - DRY_RUN=${DRY_RUN:-false}

      # Stacks Directory
      - STACKS_DIR=${STACKS_DIR:-/opt/stacks}

      # Letta Integration
      - LETTA_BASE_URL=${LETTA_BASE_URL}
      - LETTA_PASSWORD=${LETTA_PASSWORD}
      - HULY_MCP_URL=${HULY_MCP_URL:-http://192.168.50.90:3457/mcp}
      - LETTA_MODEL=${LETTA_MODEL:-anthropic/sonnet-4-5}
      - LETTA_EMBEDDING=${LETTA_EMBEDDING:-letta/letta-free}
      - LETTA_ATTACH_REPO_DOCS=${LETTA_ATTACH_REPO_DOCS:-true}
      - LETTA_UPLOAD_PROJECT_FILES=false
      - LETTA_UPLOAD_FULL_SOURCE=false
      - LETTA_SEND_MESSAGES=${LETTA_SEND_MESSAGES:-false}
      - LETTA_CONTROL_AGENT=${LETTA_CONTROL_AGENT:-Huly-PM-Control}
      - LETTA_SYNC_TOOLS_FROM_CONTROL=${LETTA_SYNC_TOOLS_FROM_CONTROL:-true}
      - LETTA_SYNC_TOOLS_FORCE=${LETTA_SYNC_TOOLS_FORCE:-false}
      - LETTA_INCREMENTAL_SYNC=${LETTA_INCREMENTAL_SYNC:-true}

      # Performance
      - API_DELAY=${API_DELAY:-10}
      - HEALTH_PORT=${HEALTH_PORT:-3099}

      # Graphiti Knowledge Graph Integration
      - GRAPHITI_ENABLED=${GRAPHITI_ENABLED:-false}
      - GRAPHITI_API_URL=${GRAPHITI_API_URL:-http://localhost:8003}
      - GRAPHITI_GROUP_ID=${GRAPHITI_GROUP_ID:-vibesync}

      # Code Perception (Real-time file watching for Graphiti)
      - CODE_PERCEPTION_ENABLED=${CODE_PERCEPTION_ENABLED:-false}
      - CODE_PERCEPTION_DEBOUNCE_MS=${CODE_PERCEPTION_DEBOUNCE_MS:-2000}
      - CODE_PERCEPTION_BATCH_SIZE=${CODE_PERCEPTION_BATCH_SIZE:-50}

      # Node Environment
      - NODE_ENV=production

      # Temporal Orchestration
      - TEMPORAL_ADDRESS=${TEMPORAL_ADDRESS:-localhost:7233}
      - USE_TEMPORAL_ORCHESTRATION=${USE_TEMPORAL_ORCHESTRATION:-true}
      - USE_TEMPORAL_BEADS=${USE_TEMPORAL_BEADS:-false}
      - USE_TEMPORAL_VIBE=${USE_TEMPORAL_VIBE:-false}
      - USE_TEMPORAL_HULY_WEBHOOK=${USE_TEMPORAL_HULY_WEBHOOK:-false}

    volumes:
      # Logs directory
      - ./logs:/app/logs

      # Use local source code (override image bundle)
      - ./index.js:/app/index.js:ro
      - ./lib:/app/lib:ro
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro

      # Temporal workflows and activities
      - ./temporal/dist:/app/temporal/dist:ro
      - ./node_modules/@temporalio:/app/node_modules/@temporalio:ro
      - ./node_modules/nexus-rpc:/app/node_modules/nexus-rpc:ro
      - ./node_modules/long:/app/node_modules/long:ro
      - ./node_modules/protobufjs:/app/node_modules/protobufjs:ro
      - ./node_modules/@protobufjs:/app/node_modules/@protobufjs:ro
      - ./node_modules/@grpc:/app/node_modules/@grpc:ro
      - ./node_modules/@js-sdsl:/app/node_modules/@js-sdsl:ro
      - ./node_modules/abort-controller:/app/node_modules/abort-controller:ro
      - ./node_modules/uuid:/app/node_modules/uuid:ro

      # Letta agent persistence (read-write for storing agent IDs)
      - ./.letta:/app/.letta

      # Access to stacks directory (read-write for state persistence)
      - /opt/stacks:/opt/stacks:rw

    network_mode: host
    user: '1000:1000'

    healthcheck:
      test:
        [
          'CMD-SHELL',
          'curl -fsS http://127.0.0.1:${HEALTH_PORT:-3099}/health | grep -q ''"status": "healthy"''',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  temporal-worker:
    build:
      context: .
      dockerfile: temporal/Dockerfile
    image: vibesync-temporal-worker:latest
    container_name: vibesync-temporal-worker
    restart: unless-stopped
    user: '1000:1000'
    environment:
      - TEMPORAL_ADDRESS=localhost:7233
      - TEMPORAL_TASK_QUEUE=vibesync-queue
      - VIBE_API_URL=${VIBE_API_URL:-http://192.168.50.90:3105/api}
      - HULY_API_URL=${HULY_API_URL:-http://192.168.50.90:3458}
      - LETTA_API_URL=${LETTA_BASE_URL:-http://192.168.50.90:8289}
      - LETTA_PASSWORD=${LETTA_PASSWORD}
      - STACKS_DIR=/opt/stacks
      - NODE_ENV=production
    volumes:
      # Access to stacks directory for Beads operations
      - /opt/stacks:/opt/stacks:rw
      # Mount local compiled Temporal code
      - ./temporal/dist:/app/temporal/dist:ro
      # Mount lib folder for database and other shared modules
      - ./lib:/app/lib:ro
      # Mount logs directory for database access
      - ./logs:/app/logs:rw
    network_mode: host
    depends_on:
      - huly-vibe-sync
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  huly-vibe-sync-ui:
    image: node:18-alpine
    container_name: huly-vibe-sync-ui
    init: true
    restart: unless-stopped
    working_dir: /app
    command: ['node', 'server.js']
    environment:
      - API_URL=${API_URL:-http://192.168.50.90:3099}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://192.168.50.90:3099}
      - NODE_ENV=production
      - HOSTNAME=0.0.0.0
      - PORT=3000
    volumes:
      - ./ui/.next/standalone:/app
      - ./ui/.next/static:/app/.next/static
      - ./ui/public:/app/public
    ports:
      - '${UI_PORT:-3110}:3000'
    labels:
      - homepage.group=Productivity
      - homepage.name=Huly Vibe Sync UI
      - homepage.icon=si-react
      - homepage.href=http://192.168.50.90:3110
      - homepage.description=Huly and Vibe synchronization dashboard
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
