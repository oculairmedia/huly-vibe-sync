version: '3.8'

services:
  huly-vibe-sync:
    image: ghcr.io/oculairmedia/huly-vibe-sync:latest
    container_name: huly-vibe-sync
    restart: unless-stopped
    environment:
      # Huly API Configuration
      - HULY_API_URL=${HULY_API_URL:-http://192.168.50.90:3457/api}
      - HULY_USE_REST=${HULY_USE_REST:-true}

      # Vibe Kanban Configuration
      - VIBE_MCP_URL=${VIBE_MCP_URL:-http://192.168.50.90:9717/mcp}
      - VIBE_API_URL=${VIBE_API_URL:-http://192.168.50.90:3105/api}

      # Sync Configuration
      - SYNC_INTERVAL=${SYNC_INTERVAL:-10000}  # 10 seconds default
      - INCREMENTAL_SYNC=${INCREMENTAL_SYNC:-true}
      - PARALLEL_SYNC=${PARALLEL_SYNC:-true}
      - MAX_WORKERS=${MAX_WORKERS:-5}
      - SKIP_EMPTY_PROJECTS=${SKIP_EMPTY_PROJECTS:-true}
      - DRY_RUN=${DRY_RUN:-false}

      # Stacks Directory
      - STACKS_DIR=${STACKS_DIR:-/opt/stacks}

      # Letta Integration
      - LETTA_BASE_URL=${LETTA_BASE_URL}
      - LETTA_PASSWORD=${LETTA_PASSWORD}
      - HULY_MCP_URL=${HULY_MCP_URL:-http://192.168.50.90:3457/mcp}
      - LETTA_MODEL=${LETTA_MODEL:-anthropic/sonnet-4-5}
      - LETTA_EMBEDDING=${LETTA_EMBEDDING:-letta/letta-free}
      - LETTA_ATTACH_REPO_DOCS=${LETTA_ATTACH_REPO_DOCS:-true}
      - LETTA_UPLOAD_PROJECT_FILES=${LETTA_UPLOAD_PROJECT_FILES:-true}
      - LETTA_UPLOAD_FULL_SOURCE=${LETTA_UPLOAD_FULL_SOURCE:-true}
      - LETTA_SEND_MESSAGES=${LETTA_SEND_MESSAGES:-false}
      - LETTA_CONTROL_AGENT=${LETTA_CONTROL_AGENT:-Huly-PM-Control}
      - LETTA_SYNC_TOOLS_FROM_CONTROL=${LETTA_SYNC_TOOLS_FROM_CONTROL:-true}
      - LETTA_SYNC_TOOLS_FORCE=${LETTA_SYNC_TOOLS_FORCE:-false}
      - LETTA_INCREMENTAL_SYNC=${LETTA_INCREMENTAL_SYNC:-true}

      # Performance
      - API_DELAY=${API_DELAY:-10}
      - HEALTH_PORT=${HEALTH_PORT:-3099}

      # Node Environment
      - NODE_ENV=production

    volumes:
      # Logs directory
      - ./logs:/app/logs

      # Letta agent persistence (read-write for storing agent IDs)
      - ./.letta:/app/.letta

      # Access to stacks directory (read-write for state persistence)
      - /opt/stacks:/opt/stacks:rw

    network_mode: host

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:${HEALTH_PORT:-3099}/health | grep -q '\"status\": \"healthy\"'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  huly-vibe-sync-ui:
    image: ghcr.io/oculairmedia/huly-vibe-sync-ui:latest
    container_name: huly-vibe-sync-ui
    pull_policy: never  # Temporarily use local image for testing
    restart: unless-stopped
    environment:
      # API Configuration
      - API_URL=${API_URL:-http://192.168.50.90:3099}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://192.168.50.90:3099}
      - NEXT_PUBLIC_POLLING_INTERVAL=${NEXT_PUBLIC_POLLING_INTERVAL:-5000}

      # Node Environment
      - NODE_ENV=production

    ports:
      - "${UI_PORT:-3101}:3000"

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
